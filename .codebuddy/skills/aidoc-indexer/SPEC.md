# AiDoc-Indexer - 规范文档

## 使用场景

- 创建新的 `INDEX.md` 或 `README.md` 索引文档
- 更新现有的索引文档内容
- 为指定目录生成索引文档
- 批量创建/更新多个索引文档

## 支持的输出类型

- `INDEX.md` - 主索引文件
- `README.md` - 目录索引文件

---

## 索引文档规范 (AiDoc 文档规范 v2.1)

### 索引文档结构约束

```yaml
KEYWORD_MAP:
  paths:
    - "相对路径/README.md"
    - "相对路径/INDEX.md"
  keywords:
    "关键词描述": "相对路径/索引文件.md"
```

### 路径格式约束

- `KEYWORD_MAP.paths` 必须为**{AIDOC_ROOT}根目录相对路径**,且仅允许指向索引文件(`README.md` / `INDEX.md`)
- 不得使用绝对路径
- 不得使用Token/Name代替路径
- 不得使用DocName代替路径

### 内容完整性约束

- 必须包含 `KEYWORD_MAP` 字段
- `KEYWORD_MAP.paths` 必须指向存在的索引文件
- 不得包含 `MODULE_MAP` 字段(已废弃)
- 不得包含源码级实现说明
- 不得包含规范中未定义的自定义字段
- 关键字必须准确描述索引内容
- 一个关键字可以映射到多个索引路径

### 索引文件内容约束

索引文件必须仅包含以下内容:

- **子目录索引文件路径**:
  - `KEYWORD_MAP.paths` 必须包含当前目录下所有直接子目录的索引文件路径
  - 仅指向 `README.md` 或 `INDEX.md` 文件
  - 不得指向非索引文件(如模块文档 `.md` 文件)

- **子模块文档路径**:
  - `KEYWORD_MAP.paths` 必须包含当前目录下的子模块文档文件路径
  - 子模块文档是指当前目录下的 `.md` 文件(非索引文件)
  - 例如:`Component.md`、`Entity.md` 等模块文档

- **关键字映射**:
  - `KEYWORD_MAP.keywords` 必须包含所有子目录和子模块的关键字映射
  - 关键字必须准确描述子目录或子模块的内容
  - 关键字可以映射到多个路径(用分号分隔)

### 目录索引完整性约束

- **每个目录都必须有索引文件**:文档目录下的每个子目录都必须包含 `README.md` 或 `INDEX.md` 索引文件
- **索引文件命名规则**:
  - 根目录使用 `INDEX.md` 作为主索引文件
  - 子目录使用 `README.md` 作为目录索引文件
- **索引文件层级关系**:
  - 父目录的 `KEYWORD_MAP.paths` 必须包含所有直接子目录的索引文件路径
  - 子目录索引文件的 `KEYWORD_MAP.paths` 必须包含其所有直接子目录的索引文件路径
- **缺失索引文件检测**:
  - 在 Stage 0 扫描时,必须检测每个目录是否存在对应的索引文件
  - 对于缺少索引文件的目录,必须标记为"待创建索引"
  - 在输出报告中必须列出所有缺少索引文件的目录
- **空目录处理**:
  - 空目录(无子目录且无文档文件)也必须创建 `README.md` 索引文件
  - 空目录的索引文件中 `KEYWORD_MAP.paths` 应为空数组 `[]`
  - 空目录的索引文件中 `KEYWORD_MAP.keywords` 应为空对象 `{}` 或省略

---

## Stage 0 约束

- 必须在所有其他 Stage 之前执行
- 如果无法自动检测,必须要求用户明确指定,不能猜测
- 检测结果必须输出到 Stage 1 及后续 Stage,供所有后续步骤使用
- 如果检测失败,必须 `StopExecution` 并报告具体原因
- **必须扫描需求中的所有文件**:包括现有索引文件
- **必须扫描所有目录**:必须扫描文档目录下的所有子目录,包括嵌套目录
- **必须检测每个目录是否有索引文件**:对于每个扫描到的目录,必须检查是否存在对应的索引文件(README.md 或 INDEX.md)
- **必须检测多余的索引文件**:对于每个现有的索引文件,必须检查其所在的目录是否存在于扫描的目录列表中
- **必须输出完整的文件清单**:包括待创建、待更新、待删除的索引文件列表
- **文件扫描结果必须传递给 Stage 1**:用于任务分配
- **必须询问用户 AiDoc/Doc 目录创建位置**:如果 `AiDoc/Doc` 目录不存在,必须询问用户要在哪里创建 `AiDoc/Doc` 目录,而不是自动创建
- **必须报告缺失的索引文件**:对于缺少索引文件的目录,必须在检测报告中列出所有缺失的索引文件路径
- **必须报告多余的索引文件**:对于索引文件存在但目录不存在的情况,必须在检测报告中列出所有多余的索引文件路径
- **不进行规范检查**:Stage 0 不检查索引文件是否符合规范(如是否包含KEYWORD_MAP、MODULE_MAP等),规范检查由 Stage 2 的 Python 扫描完成

## Stage 1 约束

- **必须创建所有待创建的索引**:必须创建 Stage 0 检测到的所有待创建索引
- **必须先读取源代码再创建**:创建索引前必须先读取对应的源代码文件,确保基于实际源代码内容生成索引
- **创建操作必须使用绝对路径**:创建索引文档时必须使用完整的绝对路径
- **必须为每个索引创建独立任务**:每个待创建的索引必须作为独立的创建任务处理,不得合并
- **必须按任务顺序执行**:必须按任务列表的顺序依次执行每个创建任务
- **必须记录任务状态**:每个任务的状态(pending → in_progress → completed/failed)必须实时更新
- **必须记录任务执行详情**:每个任务的执行结果、创建操作、错误信息必须详细记录
- **必须处理空目录**:对于空目录(无子目录且无文档文件),必须创建 README.md 索引文件,其中 `KEYWORD_MAP.paths` 为空数组 `[]`

## Stage 2 约束

- **必须先执行Python获取文件列表**:在执行更新任务前,必须先用Python获取所有索引文件列表,然后由AI助手逐个读取并检查规范
- **必须逐个检查所有索引文件规范**:必须由AI助手逐个读取索引文件,人工判断是否符合规范
- **必须更新所有待更新的索引**:必须更新 Stage 0 检测到的所有待更新索引
- **必须先读取源代码再更新**:更新索引前必须先读取对应的源代码文件,确保基于实际源代码内容更新索引
- **必须先读取现有索引再更新**:更新索引前必须先读取现有的索引文档内容,确保保留有效内容
- **更新操作必须使用绝对路径**:更新索引文档时必须使用完整的绝对路径
- **必须为每个索引创建独立任务**:每个待更新的索引必须作为独立的更新任务处理,不得合并
- **必须按任务顺序执行**:必须按任务列表的顺序依次执行每个更新任务
- **必须记录任务状态**:每个任务的状态(pending → in_progress → completed/failed)必须实时更新
- **必须记录任务执行详情**:每个任务的执行结果、更新操作、错误信息必须详细记录
- **必须在更新时修复规范问题**:对于在规范检查中被标记的索引文件,必须在更新时一并修复所有规范问题

## Stage 3 约束

- **必须逐个审查所有索引**:必须由AI助手逐个读取索引文件,人工判断是否符合规范
- **不依赖Stage 0的规范检测结果**:不使用Python扫描的规范检查结果,完全由AI助手基于实际读取的索引内容进行判断
- **必须先读取索引文件再审查**:审查前必须先读取完整的索引文件内容
- **必须先读取源代码再修复**:修复索引前必须先读取对应的源代码文件,确保基于实际源代码内容进行修复
- **修复操作必须保留规范要求的内容**:修复索引时,不得删除规范要求保留的字段(如 `KEYWORD_MAP`)
- **必须为每个索引创建独立任务**:每个不符合规范的索引必须作为独立的修复任务处理,不得合并
- **必须按任务顺序执行**:必须按任务列表的顺序依次执行每个修复任务
- **必须记录任务状态**:每个任务的状态(pending → in_progress → completed/failed)必须实时更新
- **必须记录任务执行详情**:每个任务的执行结果、修复操作、错误信息必须详细记录

---

## 索引文档模板

### INDEX.md 模板

```yaml
KEYWORD_MAP:
  paths:
    - "子目录1/README.md"
    - "子目录2/README.md"
  keywords:
    "关键词1": "子目录1/README.md"
    "关键词2": "子目录2/README.md"
    "关键词3": "子目录1/README.md;子目录2/README.md"
```

### README.md 模板

```yaml
KEYWORD_MAP:
  paths:
    - "子目录1/README.md"
    - "子目录2/README.md"
    - "模块1.md"
    - "模块2.md"
  keywords:
    "关键词1": "子目录1/README.md"
    "关键词2": "子目录2/README.md"
    "关键词3": "模块1.md"
    "关键词4": "模块2.md"
    "关键词5": "子目录1/README.md;模块1.md"
```

---

## 使用示例

### 示例 1: 为 GameBase 目录创建索引

**用户输入**:
```
为 GameBase 目录创建索引文档
```

**执行流程**:
1. Stage 0: 检测环境,扫描 GameBase 目录
2. Stage 1: 创建 GameBase/INDEX.md
3. 输出创建结果

### 示例 2: 更新所有索引文档

**用户输入**:
```
更新所有索引文档
```

**执行流程**:
1. Stage 0: 检测环境,扫描所有索引文档
2. Stage 1: 创建缺失的索引
3. Stage 2: Python扫描检查所有索引文件规范 → 更新现有的索引(修复规范问题)
4. Stage 3: (可选)AI助手补充审查和修复
5. 输出完整报告

### 示例 3: 为指定路径创建索引

**用户输入**:
```
为 AiDoc/doc/GameBase/Event 目录创建 README.md
```

**执行流程**:
1. Stage 0: 检测环境,扫描指定目录
2. Stage 1: 创建 AiDoc/doc/GameBase/Event/README.md
3. 输出创建结果

---

## 注意事项

1. **零幻觉原则**: 生成的索引文档必须基于实际源代码结构,不得包含虚构内容
2. **最小 Token 原则**: 索引文档只包含必要的字段和路径信息,不得包含冗余内容
3. **最大约束原则**: 严格遵循 AiDoc 文档规范 v2.1,不得添加未定义的字段
4. **路径一致性**: 索引文档路径必须与源代码目录结构保持一致
5. **相对路径**: 所有路径必须使用相对路径(相对于 `{AIDOC_ROOT}`),不得使用绝对路径
6. **完整性**: `KEYWORD_MAP.paths` 必须包含所有子目录的索引文件路径
7. **准确性**: 关键字必须准确描述索引内容,不得使用模糊描述
8. **目录索引完整性**: 文档目录下的每个子目录都必须包含索引文件(README.md 或 INDEX.md)
9. **索引文件命名规则**: 根目录使用 INDEX.md,子目录使用 README.md
10. **空目录处理**: 空目录也必须创建 README.md 索引文件,其中 `KEYWORD_MAP.paths` 为空数组 `[]`
